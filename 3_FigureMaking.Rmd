---
title: "3 Figure and Table Making"
output: html_document
date: "2024-11-21"
---

Includes Supplemental information 

##Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## upload necessary packages
library(tidyverse)
library(ggplot2)
library(lubridate)
library(MASS) # for KDE
library(tigris)
library(ggcorrplot)
library(scales)

## upload data
data_post2010 <- read.csv("data/analysis/master_climate_formatted_scaled.csv") %>% dplyr::select(-X) %>% 
  mutate(lizard_species = case_when(lizard_species == "Sceloporus " ~ "Sceloporus",
                                  lizard_species == "Sceloporous" ~ "Sceloporus",
                                  lizard_species == "Elgaria " ~ "Elgaria",
                                  lizard_species == "Uta.stansburia" ~ "Uta",
                                  TRUE ~ lizard_species)) %>% 
  filter(year > 2010) # omit Andrea's 2006/7 data

climate_full <- read.csv("data/climate_full_clean_20241023.csv") %>% dplyr::select(-X)

```

##Format data
```{r}
# fix lat and lon
data_post2010$lat[data_post2010$location == "Arid"] <- "35.024867"
data_post2010$lon[data_post2010$location == "Arid"] <- "-118.679283"
  
data_post2010$lat[data_post2010$location == "Intermediate"] <- "34.971886"
data_post2010$lon[data_post2010$location == "Intermediate"] <- "-118.591461"

# fix climate region
## climate 
data_post2010_formatted <- data_post2010 %>% 
  mutate_at(c("lat","lon"),as.numeric) %>% 
  mutate_at(c("lat","lon"), round, 8) %>% 
  mutate(climate_region = factor(climate_region,
                                 levels = c("North Coast",
                                            "San Francisco Bay Area",
                                            "San Joaquin Valley",
                                            "Central Coast",
                                            "Los Angeles"))) %>% 
  mutate(climate_region = case_when(# North Coast
                            location == "McLaughlin" ~ "North Coast",
                            #location == "" ~ "Sacramento Valley"
                            # SF Bay Area
                            # (check slrp that's below bay next to LFY)
                            location == "Quail Ridge" ~ "San Francisco Bay Area",
                            location == "SLRP" ~ "San Francisco Bay Area",
                            location == "SMI" ~ "San Francisco Bay Area",
                            location == "CCSP" ~ "San Francisco Bay Area",
                            location == "CC1" ~ "San Francisco Bay Area",
                            location == "CC2" ~ "San Francisco Bay Area",
                            location == "CC3" ~ "San Francisco Bay Area",
                            location == "CC4" ~ "San Francisco Bay Area",
                            location == "CC5" ~ "San Francisco Bay Area",
                            location == "CC6" ~ "San Francisco Bay Area",
                            location == "CC7" ~ "San Francisco Bay Area",
                            location == "MW1" ~ "San Francisco Bay Area",
                            location == "MW2" ~ "San Francisco Bay Area",
                            location == "MW3" ~ "San Francisco Bay Area",
                            location == "MW4" ~ "San Francisco Bay Area",
                            location == "MW5" ~ "San Francisco Bay Area",
                            location == "MW6" ~ "San Francisco Bay Area",
                            location == "MW7" ~ "San Francisco Bay Area",
                            location == "LFY" ~ "San Francisco Bay Area",
                            location == "TIL" ~ "San Francisco Bay Area",
                            location == "PR" ~ "San Francisco Bay Area",
                            location == "San Mateo" ~ "San Francisco Bay Area",
                            location == "WDLP" ~ "San Francisco Bay Area",
                            location == "PUG" ~ "San Francisco Bay Area",
                            location == "FL" ~ "San Francisco Bay Area",
                            location == "WH" ~ "San Francisco Bay Area",
                            location == "WP" ~ "San Francisco Bay Area",
                            location == "HOS" ~ "San Francisco Bay Area",
                            # San Joaquin Valley
                            # (need to fix intermediate and mesic)
                            location == "Arid" ~ "San Joaquin Valley",
                            location == "Intermediate" ~ "San Joaquin Valley",
                            location == "Mesic" ~ "San Joaquin Valley",
                            # Central Coast Region
                            location == "Fort Ord" ~ "Central Coast",
                            location == "Hastings" ~ "Central Coast",
                            location == "Big Creek" ~ "Central Coast",
                            location == "Rancho Marino" ~ "Central Coast",
                            location == "San Luis Obispo" ~ "Central Coast",
                            location == "Sedgwick" ~ "Central Coast",
                            location == "Sedgwick Reserve" ~ "Central Coast",
                            location == "Paradise Rd unburn" ~ "Central Coast",
                            location == "Santa Barbara" ~ "Central Coast",
                            location == "Coal Oil Point" ~ "Central Coast",
                            # LA Region
                            location == "Santa Rosa Island" ~ "Los Angeles",
                            location == "Santa Cruz Island" ~ "Los Angeles",
                            location == "Santa Monica Mountains" ~ "Los Angeles",
                            location == "Stunt Ranch" ~ "Los Angeles",
                            TRUE ~ "FILL"))

# create slimmed version of climate region
clim_regions_slim <- data_post2010_formatted %>% 
  dplyr::select(location, climate_region) %>%
  group_by(location) %>% 
  slice(1)

# merge climate with slim climate reigon data frame
climate_full_formatted <- climate_full %>% 
  right_join(clim_regions_slim  , by = "location") %>% 
  mutate(climate_region = factor(climate_region,
                                 levels = c("North Coast",
                                            "San Francisco Bay Area",
                                            "San Joaquin Valley",
                                            "Central Coast",
                                            "Los Angeles")))

```

##Graphical Abstract
###part 1. Map of California 
```{r}
# make california map
ca_sf <- tigris::states(cb = TRUE) %>% 
  filter(STATEFP == "06") %>% 
  st_as_sf() 

# select only 1 location lat lon
coords <- data_post2010 %>% 
  group_by(location, lat, lon) %>% 
  slice(1) 

# convert lat lon coords into sf object
coords_sf <- st_as_sf(coords,
                      coords = c("lon","lat"),
                      crs = 4326) 

# make base map
map <-
ggplot(ca_sf) +
  geom_sf() +
  geom_sf(data = ccc4, aes(fill = Name)) +
  scale_fill_manual(values =c("North Coast"  = "#90be6d",
                                    "Sacramento Valley" = "grey90",
                                    "San Francisco Bay Area" = "#43aa8b",
                                    "San Joaquin Valley"= "#f8961e",
                                    "Central Coast"= "#f9c74f",
                                    "Los Angeles"= "#f94144",
                                    "San Diego" = "grey90",
                                    "Inland South" = "grey90",
                                    "Sierra Nevada Mountains N Sierra"= "grey90",
                      "Sierra Nevada Mountains NE Sierra" = "grey90"
                      ), breaks = c("North Coast",
                                    "San Francisco Bay Area",
                                    "San Joaquin Valley",
                                    "Central Coast",
                                    "Los Angeles")) +
  coord_sf() +
  theme_pubclean() +
  annotation_scale(location = "bl") +
  annotation_north_arrow(location = "bl", which_north = "true", pad_y = unit(0.5, "in")) +
  theme(legend.position = c(.81,.8),
        legend.title = element_text(face = "bold")) +
  labs(fill = "Climate Region", tag = "A")

# make map + location dots
fig_ga_ca <- map +
  geom_sf(data = coords_sf) 

# save image
#ggsave(fig_ga_ca, file = "figures/post2010/fig_ga_ca.jpeg", dpi = 600)
```

###part 2. CDD by climate region prior to April 1

step a. calculate CDD
```{r}
# set baseline temp
baseline_temp <- 10 # 50F

# calculate for each location and year
cdd_location_year <- climate_full  %>% 
  group_by(location, lat, lon) %>% 
  na.omit() %>% 
  mutate(temp_avg = (tmmx_daily + tmmn_daily)/2) %>% 
  mutate(daily_cdd = pmax(temp_avg - baseline_temp,0)) %>%
  filter(month < 4) %>% 
  group_by(location,year) %>% 
  summarise(cumulative_cdd = sum(daily_cdd)) 

# calculate the average per location across all years
cdd_location_year_slim <- cdd_location_year %>% 
  group_by(location) %>% 
  mutate(yearly_cumulative_cdd = mean(cumulative_cdd)) %>% 
  slice(1) %>% 
  dplyr::select(location, yearly_cumulative_cdd)

# now calculate average for climate region across all years
# (total burden)
location_climatemean_peak_total <- data_post2010 %>% 
  filter(month > 2 & month < 8) %>% 
  group_by(climate_region,location, lat, lon,julian) %>% 
  summarise(total_mean = mean(total_ticks, na.rm = TRUE)) %>% 
  arrange(desc(total_mean)) %>% 
  slice(1) %>% 
  left_join(location_climatemean , by = c("location", "lat", "lon")) %>% 
  mutate(climate_region = factor(climate_region)) %>% 
  left_join(cdd_location_year_slim, by = "location") %>% 
  mutate(yearly_cumulative_cdd = log(yearly_cumulative_cdd)) %>% 
  mutate(yearly_cumulative_cdd = case_when(yearly_cumulative_cdd > 8 ~ NA,
                                           TRUE ~yearly_cumulative_cdd))

# (larval burden)
location_climatemean_peak_larva <- data_post2010 %>% 
  filter(month > 2 & month < 8) %>% 
  group_by(climate_region,location, lat, lon,julian) %>% 
  summarise(total_mean = mean(total_l, na.rm = TRUE)) %>% 
  arrange(desc(total_mean)) %>% 
  slice(1) %>% 
  left_join(location_climatemean , by = c("location", "lat", "lon")) %>% 
  mutate(climate_region = factor(climate_region)) %>% 
  left_join(cdd_location_year_slim, by = "location") %>% 
  mutate(yearly_cumulative_cdd = log(yearly_cumulative_cdd)) %>% 
  mutate(yearly_cumulative_cdd = case_when(yearly_cumulative_cdd > 8 ~ NA,
                                           TRUE ~yearly_cumulative_cdd))

# (nymphal burden)
location_climatemean_peak_nymph <- data_post2010 %>% 
  filter(month > 2 & month < 8) %>% 
  group_by(climate_region,location, lat, lon,julian) %>% 
  summarise(total_mean = mean(total_n, na.rm = TRUE)) %>% 
  arrange(desc(total_mean)) %>% 
  slice(1) %>% 
  left_join(location_climatemean , by = c("location", "lat", "lon")) %>% 
  mutate(climate_region = factor(climate_region)) %>% 
  left_join(cdd_location_year_slim, by = "location") %>% 
  mutate(yearly_cumulative_cdd = log(yearly_cumulative_cdd)) %>% 
  mutate(yearly_cumulative_cdd = case_when(yearly_cumulative_cdd > 8 ~ NA,
                                           TRUE ~yearly_cumulative_cdd))

```

step b. plot it
```{r}
fig_ga_cdd <- 
cdd_location_year %>% 
  right_join(clim_regions_slim, by = "location") %>% 
  mutate(log_cdd = log(cumulative_cdd)) %>% 
  filter(log_cdd < 10) %>% 
  filter(year > 2013 &
           climate_region != "North Coast" &
           climate_region != "San Joaquin Valley") %>% 
  ggplot(aes(x = climate_region, y = log_cdd)) +
  geom_boxplot(aes(fill = climate_region)) +
  scale_x_discrete(
                   limits = c("San Francisco Bay Area" = "San Francisco Bay Area",
                              "Central Coast" = "Central Coast",
                              "Los Angeles" = "Los Angeles" ),
                   labels = c("San Francisco Bay Area" = "San Francisco",
                              "Central Coast" = "Central Coast",
                              "Los Angeles" = "Los Angeles" )) +
  theme_clean +
  scale_fill_manual(values =  c(#"North Coast" = "#90be6d",
            "San Francisco Bay Area" = "#43aa8b",
            #"San Joaquin Valley" = "#f8961e",
            "Central Coast" = "#f9c74f", 
            "Los Angeles" = "#f94144")) +
  guides(fill = FALSE) +
  labs(x = "", y = "log(CDD > 10°C) prior to April", tag = "B") +
  theme(axis.text.x = element_text(angle = 90))+
  annotate("text", x = 2.3, y = 3.9,label = "CDD = cumulative degree days", size = 4)

#ggsave(fig_ga_cdd, file = "figures/post2010/fig_ga_cdd.jpeg", dpi = 600)

```

###part 3. julian curves

step a. larvae
```{r}
# calculate 
climjulianagg_larva <- 
data_post2010_formatted %>% 
  mutate(climate_region = case_when(location == "McLaughlin" ~ "San Francisco Bay Area", 
                                    location == "Arid" ~ "Los Angeles",
                                    location == "Intermediate" ~ "Los Angeles",
                                    location == "Mesic" ~ "Los Angeles",
                                    TRUE ~ climate_region)) %>% 
  group_by(climate_region, julian) %>% 
  summarise(larva_mean = mean(total_l, na.rm = TRUE)) %>% 
  arrange(desc(larva_mean)) %>% 
  slice(1)

# plot
fig_ga_larvae <- 
data_post2010_formatted %>% 
  group_by(climate_region, julian) %>% 
  summarise(larva_mean = mean(total_l, na.rm = TRUE)) %>% 
  ggplot(aes(x = julian, y = larva_mean)) +
  geom_jitter(aes(color = climate_region)) +
  scale_color_manual(values = colors) +
  geom_smooth(color = "black", fill = "grey90",
              aes(ymin = ifelse(..ymin.. <0,0, ..ymin..))) +
  theme_clean +
  scale_x_continuous(expand = c(0,0)) +  
  xlim(60,160) +
  labs(x = "Julian Date", y = "Mean Ticks per Lizard", tag = "C")  +
  geom_vline(data = climjulianagg_larva, aes(xintercept = julian, 
             color = climate_region),  size = 2, alpha = .9, show.legend = FALSE) +
  annotate("text",label = paste("  Larvae"), x = 64, y = 40, fontface = 2) +
  guides(color = FALSE)

```

step b. nymphs
```{r}
# calculate 
climjulianagg_nymph <- 
data_post2010_formatted %>% 
  mutate(climate_region = case_when(location == "McLaughlin" ~ "San Francisco Bay Area", 
                                    location == "Arid" ~ "Los Angeles",
                                    location == "Intermediate" ~ "Los Angeles",
                                    location == "Mesic" ~ "Los Angeles",
                                    TRUE ~ climate_region)) %>% 
  group_by(climate_region, julian) %>% 
  summarise(nymph_mean = mean(total_n, na.rm = TRUE)) %>% 
  arrange(desc(nymph_mean)) %>% 
  slice(1)

# plot
fig_ga_nymph <- 
data_post2010_formatted %>% 
  group_by(climate_region, julian) %>% 
  summarise(nymph_mean = mean(total_n, na.rm = TRUE)) %>% 
  ggplot(aes(x = julian, y = nymph_mean)) +
  geom_jitter(aes(color = climate_region)) +
  scale_color_manual(values = colors) +
  geom_smooth(color = "black", fill = "grey90",
              aes(ymin = ifelse(..ymin.. <0,0, ..ymin..))) +
  theme_clean +
  scale_x_continuous(expand = c(0,0)) +  
  xlim(60,160) +
  labs(x = "Julian Date", y = "Mean Ticks per Lizard")  +
  geom_vline(data = climjulianagg_nymph, aes(xintercept = julian, 
             color = climate_region),  size = 2, alpha = .9, show.legend = FALSE) +
  annotate("text",label = paste("  Nymphs"), x = 66, y = 20, fontface = 2) +
  guides(color = FALSE)

```

###part 4. arrange figure
```{r}

## arrange juvenile curves
curves <- ggarrange(fig_ga_larvae + rremove("ylab") + rremove("xlab"), 
                    fig_ga_nymph + rremove("ylab") + rremove("xlab"),
                    ncol = 1, align = "hv")

# annotate them
curves_an <- annotate_figure(curves, 
                left = text_grob("Mean Ticks per Lizard", 
                                 rot = 90, vjust = .5,face = "bold"))

# combine cdd with curves
fig_ga_cddcurves <- ggarrange(fig_ga_cdd, curves_an, ncol = 2)

## save figures
#ggsave(fig_ga_cddcurves, file = "figures/post2010/fig_ga_cddcurves.jpeg", dpi = 600)
#ggsave(fig_ga_ca, file = "figures/post2010/fig_ga_ca.jpeg", dpi = 600)

```

#Figures

##Figure 1 - Study system

part A. map of California
```{r}
# make california map
ca_sf <- tigris::states(cb = TRUE) %>% 
  filter(STATEFP == "06") %>% 
  st_as_sf() 

# select only 1 location lat lon
coords <- data_post2010 %>% 
  group_by(location, lat, lon) %>% 
  slice(1) 

# convert lat lon coords into sf object
coords_sf <- st_as_sf(coords,
                      coords = c("lon","lat"),
                      crs = 4326) 

# make base map
map <-
ggplot(ca_sf) +
  geom_sf() +
  geom_sf(data = ccc4, aes(fill = Name)) +
  scale_fill_manual(values =c("North Coast"  = "#90be6d",
                                    "Sacramento Valley" = "grey90",
                                    "San Francisco Bay Area" = "#43aa8b",
                                    "San Joaquin Valley"= "#f8961e",
                                    "Central Coast"= "#f9c74f",
                                    "Los Angeles"= "#f94144",
                                    "San Diego" = "grey90",
                                    "Inland South" = "grey90",
                                    "Sierra Nevada Mountains N Sierra"= "grey90",
                      "Sierra Nevada Mountains NE Sierra" = "grey90"
                      ), breaks = c("North Coast",
                                    "San Francisco Bay Area",
                                    "San Joaquin Valley",
                                    "Central Coast",
                                    "Los Angeles")) +
  coord_sf() +
  theme_pubclean() +
  annotation_scale(location = "bl") +
  annotation_north_arrow(location = "bl", which_north = "true", pad_y = unit(0.5, "in")) +
  theme(legend.position = c(.81,.8),
        legend.title = element_text(face = "bold")) +
  labs(fill = "Climate Region", tag = "A")

# make map + location dots
fig_ga_ca <- map +
  geom_sf(data = coords_sf) 

# save image
#ggsave(fig_ga_ca, file = "figures/post2010/fig_ga_ca.jpeg", dpi = 600)

```

part B. cumulative degree days

step i. calculate CDD
```{r}
# set baseline temp
baseline_temp <- 10 # 50F

# calculate for each location and year
cdd_location_year <- climate_full  %>% 
  group_by(location, lat, lon) %>% 
  na.omit() %>% 
  mutate(temp_avg = (tmmx_daily + tmmn_daily)/2) %>% 
  mutate(daily_cdd = pmax(temp_avg - baseline_temp,0)) %>%
  filter(month < 4) %>% 
  group_by(location,year) %>% 
  summarise(cumulative_cdd = sum(daily_cdd)) 

# calculate the average per location across all years
cdd_location_year_slim <- cdd_location_year %>% 
  group_by(location) %>% 
  mutate(yearly_cumulative_cdd = mean(cumulative_cdd)) %>% 
  slice(1) %>% 
  dplyr::select(location, yearly_cumulative_cdd)

# now calculate average for climate region across all years
# (total burden)
location_climatemean_peak_total <- data_post2010 %>% 
  filter(month > 2 & month < 8) %>% 
  group_by(climate_region,location, lat, lon,julian) %>% 
  summarise(total_mean = mean(total_ticks, na.rm = TRUE)) %>% 
  arrange(desc(total_mean)) %>% 
  slice(1) %>% 
  left_join(location_climatemean , by = c("location", "lat", "lon")) %>% 
  mutate(climate_region = factor(climate_region)) %>% 
  left_join(cdd_location_year_slim, by = "location") %>% 
  mutate(yearly_cumulative_cdd = log(yearly_cumulative_cdd)) %>% 
  mutate(yearly_cumulative_cdd = case_when(yearly_cumulative_cdd > 8 ~ NA,
                                           TRUE ~yearly_cumulative_cdd))

# (larval burden)
location_climatemean_peak_larva <- data_post2010 %>% 
  filter(month > 2 & month < 8) %>% 
  group_by(climate_region,location, lat, lon,julian) %>% 
  summarise(total_mean = mean(total_l, na.rm = TRUE)) %>% 
  arrange(desc(total_mean)) %>% 
  slice(1) %>% 
  left_join(location_climatemean , by = c("location", "lat", "lon")) %>% 
  mutate(climate_region = factor(climate_region)) %>% 
  left_join(cdd_location_year_slim, by = "location") %>% 
  mutate(yearly_cumulative_cdd = log(yearly_cumulative_cdd)) %>% 
  mutate(yearly_cumulative_cdd = case_when(yearly_cumulative_cdd > 8 ~ NA,
                                           TRUE ~yearly_cumulative_cdd))

# (nymphal burden)
location_climatemean_peak_nymph <- data_post2010 %>% 
  filter(month > 2 & month < 8) %>% 
  group_by(climate_region,location, lat, lon,julian) %>% 
  summarise(total_mean = mean(total_n, na.rm = TRUE)) %>% 
  arrange(desc(total_mean)) %>% 
  slice(1) %>% 
  left_join(location_climatemean , by = c("location", "lat", "lon")) %>% 
  mutate(climate_region = factor(climate_region)) %>% 
  left_join(cdd_location_year_slim, by = "location") %>% 
  mutate(yearly_cumulative_cdd = log(yearly_cumulative_cdd)) %>% 
  mutate(yearly_cumulative_cdd = case_when(yearly_cumulative_cdd > 8 ~ NA,
                                           TRUE ~yearly_cumulative_cdd))

```

step ii. plot it
```{r}
fig_1_cdd <- 
cdd_location_year %>% 
  right_join(clim_regions_slim, by = "location") %>% 
  mutate(log_cdd = log(cumulative_cdd)) %>% 
  filter(log_cdd < 10) %>% 
  filter(year > 2013 &
           climate_region != "North Coast" &
           climate_region != "San Joaquin Valley") %>% 
  ggplot(aes(x = climate_region, y = log_cdd)) +
  geom_boxplot(aes(fill = climate_region)) +
  scale_x_discrete(
                   limits = c("San Francisco Bay Area" = "San Francisco Bay Area",
                              "Central Coast" = "Central Coast",
                              "Los Angeles" = "Los Angeles" ),
                   labels = c("San Francisco Bay Area" = "SF",
                              "Central Coast" = "CC",
                              "Los Angeles" = "LA" )) +
  theme_clean +
  scale_fill_manual(values =  c(#"North Coast" = "#90be6d",
            "San Francisco Bay Area" = "#43aa8b",
            #"San Joaquin Valley" = "#f8961e",
            "Central Coast" = "#f9c74f", 
            "Los Angeles" = "#f94144")) +
  guides(fill = FALSE) +
  labs(x = "", y = "log(CDD > 10°C) prior to April", tag = "A") +
  #theme(axis.text.x = element_text(angle = 90))+
  annotate("text", x = 2.3, y = 9,label = "CDD = cumulative degree days", size = 3)

#ggsave(fig_1_cdd, file = "figures/post2010/fig_1_cdd.jpeg", dpi = 600)

```


part C. monthly max temperature
```{r}

fig_1_tmax_monthly <- 
climate_full_formatted %>% 
  filter(year > 2012 &
           climate_region != "North Coast" & # changed this
           climate_region != "San Joaquin Valley") %>% # changed this
  group_by(climate_region, year) %>% 
  summarise(mean = mean(tmmx_monthly, na.rm = TRUE)) %>% 
  ggplot(aes(x = year, y = mean,color = climate_region)) +
  geom_smooth(fill = "grey95", size = 1.2) + #fill = "grey90",
  theme_clean +
  scale_color_manual(values = c("North Coast" = "#90be6d",
            "San Francisco Bay Area" = "#43aa8b",
            "San Joaquin Valley" = "#f8961e",
            "Central Coast" = "#f9c74f", 
            "Los Angeles" = "#f94144")) +
  scale_x_continuous(expand = c(0,0.18), breaks = seq(2013,2022,3)) +
  labs(x = "", y = "Monthly Max Temp (°C)", tag = "B")+
  guides(color = FALSE) #+
  theme(axis.text.x = element_text(hjust = .7,size = 12))
```

part D. monthly sph
```{r}
  library(scales)
fig_1_sph_monthly <-
climate_full_formatted %>% 
  filter(year > 2012 &
           climate_region != "North Coast" & 
           climate_region != "San Joaquin Valley") %>% 
  group_by(climate_region, year) %>% 
  summarise(mean = mean(sph_monthly, na.rm = TRUE)) %>% 
  ggplot(aes(x = year, y = mean,color = climate_region)) +
  geom_smooth(fill = "grey95", size = 1.2) + #fill = "grey90",
  theme_clean +
  scale_color_manual(values = c("North Coast" = "#90be6d",
            "San Francisco Bay Area" = "#43aa8b",
            "San Joaquin Valley" = "#f8961e",
            "Central Coast" = "#f9c74f", 
            "Los Angeles" = "#f94144")) +
  scale_x_continuous(expand = c(0,0.18), breaks = seq(2013,2022,3)) +
  labs(x = "", y = "Monthly Specific Humidity", tag = "C")+
  guides(color = FALSE)+
    scale_y_continuous(labels = label_number(scale = 1000, accuracy = .1)) #+
  theme(axis.text.x = element_text(hjust = .7,size = 12)) 
```

part E. pdsi
```{r}
fig_1_pdsi_monthly <-
climate_full_formatted %>% 
  filter(year > 2012 &
           climate_region != "North Coast" & 
           climate_region != "San Joaquin Valley") %>% 
  group_by(climate_region, year) %>% 
  summarise(mean = mean(pdsi_monthly, na.rm = TRUE)) %>% 
  ggplot(aes(x = year, y = mean,color = climate_region)) +
  geom_smooth(fill = "grey95", size = 1.2) + #fill = "grey90",
  theme_clean +
  scale_color_manual(values = c("North Coast" = "#90be6d",
            "San Francisco Bay Area" = "#43aa8b",
            "San Joaquin Valley" = "#f8961e",
            "Central Coast" = "#f9c74f", 
            "Los Angeles" = "#f94144")) +
  scale_x_continuous(expand = c(0,0.18), breaks = seq(2013,2022,3)) +
  labs(x = "", y = "Monthly Drought Index (PDSI)", tag = "D")+
  guides(color = FALSE) +
  geom_hline(yintercept = 0, lty = 2) +
  annotate("text",label = paste("wet"), x = 2013.8, y = 2,fontface = 2, size = 6)+
  annotate("text",label = paste("dry"), x = 2013.8,  y = -2,fontface = 2, size = 6)

```

Arrange B-E
```{r}
# fix labels for ggarrange
fig_1_cdd_an <-fig_1_cdd + labs(y = "log(CDD > 10°C)", tag = "B ")
fig_1_tmax_monthly_an <- fig_1_tmax_monthly + labs(y = "Max Temp °C", tag = "C ")
fig_1_sph_monthly_an <- fig_1_sph_monthly + labs(y = "Humidity mg/kg", tag = "D ") 
fig_1_pdsi_monthly_an <- fig_1_pdsi_monthly + labs(y = "Drought Index PDSI", tag = "E ") 

# make ggarrance
fig_1_climatevars <- ggarrange(fig_1_cdd_an , 
          fig_1_tmax_monthly_an, 
          fig_1_sph_monthly_an, 
          fig_1_pdsi_monthly_an,
          align = "hv")

#ggsave(fig_1_climatevars, file = "figures/post2010/fig_1_climatevars.jpeg", dpi = 600)
```


##Figure 2 - Mean tick burdens

part i. calculate means
```{r}
mean_l <- data_post2010_formatted %>% 
  filter(climate_region != "North Coast" &
           climate_region != "San Joaquin Valley") %>% 
   filter(month > 2) %>% 
  filter(!is.na(total_l) &
           !is.na(total_n)) %>%
   group_by(climate_region, month) %>% 
  summarise(mean = mean(total_l, na.rm = TRUE),
            sd = sd(total_l, na.rm = TRUE)) %>% 
  mutate(lifestage = "Larvae")

mean_n <- data_post2010_formatted %>% 
  filter(climate_region != "North Coast" &
           climate_region != "San Joaquin Valley") %>% 
   filter(month > 2) %>% 
  filter(!is.na(total_l) &
           !is.na(total_n)) %>%
   group_by(climate_region, month) %>% 
  summarise(mean = mean(total_n, na.rm = TRUE),
            sd = sd(total_l, na.rm = TRUE)) %>% 
  mutate(lifestage = "Nymphs")

mean <- rbind(mean_l, mean_n) %>% 
  mutate(climate_region = factor(climate_region,
                                 levels = c(#"North Coast",
                                            "San Francisco Bay Area",
                                            #"San Joaquin Valley",
                                            "Central Coast",
                                            "Los Angeles")))
```

part ii. plot means
```{r}

fig_2_mean_CR3 <- mean %>% 
 ggplot(aes(x = month, y = mean, fill = lifestage)) +
    geom_errorbar(aes(ymin = mean, ymax = mean+sd), 
                  position = position_dodge2(width = .01, padding = .5)) +
  geom_col(stat = "identity", position = "dodge") +
     facet_wrap(~climate_region, ncol = 1, scale = "free_y") +
     theme_minimal() + #minimal light pubclean
     theme(strip.text = element_text(face = "bold", size = 11),#13
           axis.title.y = element_text(size = 12),
           axis.text.x = element_text(size = 12),
           panel.grid.major.x = element_blank(),
           panel.grid.minor.x = element_blank(),
           panel.grid.minor.y = element_blank(),
           legend.position = "right") +
     labs(x = "", y = "Mean Tick Burden on Individual Lizard", fill = "Life stage") +
     scale_x_continuous(breaks = c(3,4,5,6),
                      labels = c("March", "April", "May", "June")) +
     scale_fill_manual(values = c("#004488","#ddaa33")) +
  scale_y_continuous(labels = label_number(accuracy = 1))

#ggsave(fig_2_mean_CR3, file = "figures/post2010/fig_2_mean_CR3.jpeg", dpi = 600)

```

##Figure 3 - GAM model results

#Supplement

##Additional File 1 -- Sampling location and frequency

###Table S1 -- location coordinates
```{r}
table_sup_1_1 <- data_post2010_formatted %>% 
  dplyr::select(location, collector, lat, lon) %>%
  unique() %>% 
  mutate(across(c(lat:lon), round,5)) %>% 
  arrange(desc(lat))

#write.csv(table_sup_1_1,file = "table_sup_1_1.csv",
#            row.names = FALSE,quote = FALSE)

```


###Table S2 -- location sampling dates
```{r}
table_sup_1_2 <- data_post2010_formatted %>% 
  filter(month != 9) %>% 
  group_by(location, year, month) %>% 
  tally() %>% 
  pivot_wider(names_from = month, values_from = n)

#write.csv(table_sup_1_2,file = "table_sup_1_2.csv",
#            row.names = FALSE,quote = FALSE)
```



##Additional File 2 -- Location characteristics

###Figure S1 - Sampling frequencies
```{r}
fig_sup_2_1_samplingfrequency <- 
data_post2010_formatted %>% 
  mutate(location = case_when(location == "Santa Monica Mountains" ~ "SM Mtns",
                              location == "Sedgwick Reserve" ~ "Sedgwick-Sp",
                              location == "Sedgwick" ~ "Sedgwick-Sa",
                              location == "Santa Rosa Island"~ "SR Island",
                              location == "Santa Cruz Island" ~ "SC Island",
                              location == "Paradise Rd unburn" ~ "Paradise Rd",
                              location == "San Luis Obispo" ~ "SLO",
                              TRUE ~ location),
         lat = case_when(location == "Intermediate" ~ 34.97000, # fix so Tejon is next to eachother on y axis
                              TRUE ~ lat)) %>% 
  group_by(location, date, lat, climate_region) %>% 
  tally() %>% 
  #arrange(desc(lat)) %>% 
  ggplot(aes(x = n, y = reorder(location, lat))) +
  geom_bar(stat = "identity", aes(fill = climate_region)) +
  scale_fill_manual(values =  c("North Coast" = "#90be6d",
            "San Francisco Bay Area" = "#43aa8b",
            "San Joaquin Valley" = "#f8961e",
            "Central Coast" = "#f9c74f", 
            "Los Angeles" = "#f94144"), 
            breaks = c("North Coast", "San Francisco Bay Area","San Joaquin Valley",
                       "Central Coast", "Los Angeles")) +
  theme_clean +
  scale_y_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(axis.text.y = element_text(size = 8),
        legend.position = c(.7,.65),
        legend.title = element_text(face = "bold")) +
  labs(x = "Location Visit Frequency",y = "", fill = "Climate Region") +
  geom_vline(xintercept = 3, lty = 2) +
    scale_x_continuous(expand = c(0,0)) +
  annotate(geom = "text", x = 85, y = 31, label = "38°N", size = 6) +
  annotate(geom = "text", x = 85, y = 4, label = "33°N", size = 6)
  
#38.87289
#33.9773

#ggsave(fig_sup_2_1_samplingfrequency, file = "figures/post2010/fig_sup_2_1_samplingfrequency.jpeg", dpi = 600,
#       height = 5, width = 5)


```

###Figure S2 -- lizard captures
```{r}
fig_sup_2_2_lizardcaptures <- 
data_post2010_formatted %>% 
  mutate(location = case_when(location == "Santa Monica Mountains" ~ "SM Mtns",
                              location == "Sedgwick Reserve" ~ "Sedgwick-Sp",
                              location == "Sedgwick" ~ "Sedgwick-Sa",
                              location == "Santa Rosa Island"~ "SR Island",
                              location == "Santa Cruz Island" ~ "SC Island",
                              location == "Paradise Rd unburn" ~ "Paradise Rd",
                              location == "San Luis Obispo" ~ "SLO",
                              TRUE ~ location),
         lat = case_when(location == "Intermediate" ~ 34.97000, # fix so Tejon is next to eachother on y axis
                              TRUE ~ lat)) %>% 
  group_by(location, lat, climate_region, date) %>% 
  tally() %>% 
  ggplot(aes(x = n, y = reorder(location, lat))) +
  geom_boxplot(aes(fill = climate_region)) +
  scale_fill_manual(values =  c("North Coast" = "#90be6d",
            "San Francisco Bay Area" = "#43aa8b",
            "San Joaquin Valley" = "#f8961e",
            "Central Coast" = "#f9c74f", 
            "Los Angeles" = "#f94144"), 
            breaks = c("North Coast", "San Francisco Bay Area","San Joaquin Valley",
                       "Central Coast", "Los Angeles")) +
  theme_clean +
  scale_y_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(axis.text.y = element_text(size = 8),
        legend.position = "bottom",
        #legend.position = c(.8,.62),
        legend.title = element_text(face = "bold")) +
  labs(x = "Total Lizards Observed",y = "", fill = "")+
    scale_x_continuous(expand = c(0,0)) +
  guides(fill = guide_legend(nrow = 3)) 

#ggsave(fig_sup_2_2_lizardcaptures, file = "figures/post2010/fig_sup_2_2_lizardcaptures.jpeg", 
#       dpi = 600,height = 5, width = 5)
```

###Table S1 -- tick mean and standard deviation
```{r}
table_sup_2_1 <- data_post2010_formatted %>% 
  group_by(location, lat) %>% 
  summarise(mean_total = mean(total_ticks, na.rm = TRUE),
            sd_total = sd(total_ticks, na.rm = TRUE),
            mean_l = mean(total_l, na.rm = TRUE),
            sd_l = sd(total_l, na.rm = TRUE),
            mean_n = mean(total_n, na.rm = TRUE),
            sd_n = sd(total_n, na.rm = TRUE)) %>% 
  mutate(across(c(mean_total:sd_n), round,3)) %>% 
  arrange(desc(lat))

#write.csv(table_sup_2_1,file = "table_sup_2_1.csv",col.names = FALSE,
#            row.names = FALSE,quote = FALSE)
```



##Additional File 3 -- Method details

###Figure S1 - Correlations
```{r}

fig_sup_3_1_correlations_numeric <- 
data_post2010_formatted %>% 
  dplyr::select(tmmn_daily:tmmx_winter) %>% drop_na()

corr <- round(cor(fig_sup_3_1_correlations_numeric),1)

fig_sup_3_1_correlations <- ggcorrplot(corr,
           hc.order = TRUE,
           type = "upper",
           outline.col = "white",
           ggtheme = ggplot2::theme_light(),
           colors = c("#6d9ec1", "white","#e46726"),
           tl.cex = 8)

#ggsave(fig_sup_3_1_correlations, file = "figures/post2010/fig_sup_3_1_correlations.jpeg", dpi = 600,
#       height = 5, width = 5)
```

##Additional File 4 -- Phenological metrics

###Figure S1 -- histogram of juvenile burdens
```{r}


fig_sup_4_1a <- data_post2010_formatted %>% 
  filter(climate_region == "Central Coast"|
         climate_region == "Los Angeles" |
           climate_region == "San Francisco Bay Area") %>% 
  group_by(location, date, climate_region) %>% 
  summarise(mean_larvae = mean(total_l, na.rm = TRUE)) %>% 
  ggplot(aes(x = mean_larvae))+
  geom_histogram(fill = "grey95", color = "grey15") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  theme_clean +
  facet_wrap(~factor(climate_region, c("San Francisco Bay Area",
                                       "Central Coast",
                                       "Los Angeles")), ncol = 1) +
  theme_minimal() +
  theme(strip.text = element_text(face= "bold", size = 12)) +
  labs(x = "Mean Larvae on Individual Lizard", y = "Frequency",
       tags = "A")


fig_sup_4_1b <- data_post2010_formatted %>% 
  filter(climate_region == "Central Coast"|
         climate_region == "Los Angeles" |
           climate_region == "San Francisco Bay Area") %>% 
  group_by(location, date, climate_region) %>% 
  summarise(mean_nymphs = mean(total_n, na.rm = TRUE)) %>% 
  ggplot(aes(x = mean_nymphs))+
  geom_histogram(fill = "grey95", color = "grey15") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  theme_clean +
  facet_wrap(~factor(climate_region, c("San Francisco Bay Area",
                                       "Central Coast",
                                       "Los Angeles")), ncol = 1) +
  theme_minimal() +
  theme(strip.text = element_text(face= "bold", size = 12)) +
  labs(x = "Mean Nymphs on Individual Lizard", y = "Frequency",
       tags = "B")


fig_sup_4_1 <- ggarrange(fig_sup_4_1a ,fig_sup_4_1b)

#ggsave(fig_sup_4_1, file = "figures/post2010/fig_sup_4_1.jpeg", dpi = 600,
#       height = 5, width = 7)

```


###Figure S2 -- juvenile burdens by month and year
```{r}
fig_sup_4_1a <- data_post2010_formatted %>% 
  filter(month != 9) %>% 
  group_by(climate_region,location, date, month) %>% 
  ggplot(aes(x = as.factor(month), y = total_ticks))  +
  scale_color_manual(values =  c("North Coast" = "#90be6d",
            "San Francisco Bay Area" = "#43aa8b",
            "San Joaquin Valley" = "#f8961e",
            "Central Coast" = "#f9c74f", 
            "Los Angeles" = "#f94144")) +
    geom_jitter(aes(color = climate_region), alpha = .5, width = .25) +
    geom_boxplot(fill = "grey90") +
  theme_clean +
  scale_x_discrete(labels = c("Feb", "March", "April", 
                              "May", "June")) +
  labs(x = "", y = "Raw Tick Counts per Lizard", color = "", tag = "A") +
  #guides(color = FALSE)
  theme(legend.position = "bottom",
        legend.title = element_text(face = "bold")) +
  guides(color = guide_legend(nrow = 1) ) 


fig_sup_4_1b <- data_post2010_formatted %>% 
  group_by(climate_region,location, date, year) %>% 
  ggplot(aes(x = as.factor(year), y = total_ticks)) +
  scale_color_manual(values =  c("North Coast" = "#90be6d",
            "San Francisco Bay Area" = "#43aa8b",
            "San Joaquin Valley" = "#f8961e",
            "Central Coast" = "#f9c74f", 
            "Los Angeles" = "#f94144")) +
    geom_jitter(aes(color = climate_region), alpha = .5, width = .25) +
    geom_boxplot(fill = "grey90") +
  theme_clean +
  labs(x = "", y = "Raw Tick Counts per Lizard", color = "", tag = "B") +
  theme(legend.position = "bottom",
        legend.title = element_text(face = "bold")) +
  guides(color = guide_legend(nrow = 1) )

fig_sup_4_1 <- ggarrange(fig_sup_4_1a, fig_sup_4_1b + rremove("ylab"),
          common.legend = TRUE, ncol = 2,
          legend = "bottom",
          align = "hv", widths = c(.8,1))

#ggsave(fig_sup_4_1, file = "figures/post2010/fig_sup_4_1.jpeg", dpi = 600,
#       height = 5, width = 10)

```

###Table S1 -- Phenology metrics

Density
```{r}
#table_sup_2_1 <- data_post2010_formatted

# Total
data_post2010 %>% 
  group_by(climate_region) %>% 
  filter(month > 2 & month < 7) %>% 
    mutate(climate_region = factor(climate_region,
                                 levels = c("North Coast", 
                                   "San Francisco Bay Area", "San Joaquin Valley",
                                   "Central Coast", "Los Angeles"))) %>% 
  summarise(total_mean = mean(total_ticks, na.rm = TRUE),
            total_sd = sd(total_ticks, na.rm = TRUE)) %>% 
  mutate_at(c("total_mean","total_sd"), round, 2) 


# Larvae
data_post2010 %>% 
  group_by(climate_region) %>% 
  filter(month > 2 & month < 7) %>% 
    mutate(climate_region = factor(climate_region,
                                 levels = c("North Coast", 
                                   "San Francisco Bay Area", "San Joaquin Valley",
                                   "Central Coast", "Los Angeles"))) %>% 
  summarise(total_mean = mean(total_l, na.rm = TRUE),
            total_sd = sd(total_l, na.rm = TRUE)) %>% 
  mutate_at(c("total_mean","total_sd"), round, 2) 


# Nymphs
data_post2010 %>% 
  group_by(climate_region) %>% 
  filter(month > 2 & month < 7) %>% 
    mutate(climate_region = factor(climate_region,
                                 levels = c("North Coast", 
                                   "San Francisco Bay Area", "San Joaquin Valley",
                                   "Central Coast", "Los Angeles"))) %>% 
  summarise(total_mean = mean(total_n, na.rm = TRUE),
            total_sd = sd(total_n, na.rm = TRUE)) %>% 
  mutate_at(c("total_mean","total_sd"), round, 2) 

```

Peak abundance
```{r}

##larva
data_post2010_formatted %>% 
  filter(month > 2 & month < 7) %>% 
  mutate(climate_region = factor(climate_region,
                                 levels = c("North Coast", 
                                   "San Francisco Bay Area", "San Joaquin Valley",
                                   "Central Coast", "Los Angeles"))) %>% 
  group_by(climate_region, julian) %>% 
  summarise(total_l = mean(total_l, na.rm = TRUE)) %>% 
  arrange(desc(total_l)) %>% 
  slice(1)

##nymph
data_post2010_formatted %>% 
  filter(month > 2 & month < 7) %>% 
  mutate(climate_region = factor(climate_region,
                                 levels = c("North Coast", 
                                   "San Francisco Bay Area", "San Joaquin Valley",
                                   "Central Coast", "Los Angeles"))) %>% 
  group_by(climate_region, julian) %>% 
  summarise(total_n = mean(total_n, na.rm = TRUE)) %>% 
  arrange(desc(total_n)) %>% 
  slice(1)
```

Duration of season
min and max date (mean > 0)
```{r}
## larva
data_post2010_formatted %>% 
  filter(month > 2 & month < 7) %>% 
  mutate(climate_region = factor(climate_region,
                                 levels = c("North Coast", 
                                   "San Francisco Bay Area", "San Joaquin Valley",
                                   "Central Coast", "Los Angeles"))) %>% 
  group_by(climate_region, julian) %>% 
  summarise(mean_l = mean(total_l, na.rm = TRUE)) %>% 
  filter(mean_l > 0) %>% 
  summarise(min_j = min(julian, na.rm = TRUE),
            max_j = max(julian, na.rm = TRUE),
            length = (max_j-min_j))


## nymph
## larva
data_post2010_formatted %>% 
  filter(month > 2 & month < 7) %>% 
  mutate(climate_region = factor(climate_region,
                                 levels = c("North Coast", 
                                   "San Francisco Bay Area", "San Joaquin Valley",
                                   "Central Coast", "Los Angeles"))) %>% 
  group_by(climate_region, julian) %>% 
  summarise(mean_n = mean(total_n, na.rm = TRUE)) %>% 
  filter(mean_n > 0) %>% 
  summarise(min_j = min(julian, na.rm = TRUE),
            max_j = max(julian, na.rm = TRUE),
            length = (max_j-min_j))


```

Overlap metrics

part a. KDE
```{r}
tick_data <- data_post2010_formatted %>% 
    filter(month > 2 & month < 7) %>%
    filter(climate_region == "San Francisco Bay Area") %>% # change this out for region
  group_by(julian) %>% 
  summarise(total_l = mean(total_l, na.rm = TRUE),
            total_n = mean(total_n, na.rm = TRUE)) %>% 
  dplyr::select(julian, total_l, total_n) %>% 
  rename(Date = julian,
         Larvae_Count = total_l,
         Nymphs_Count = total_n) %>% 
  na.omit()

# Create density estimates
larval_density <- density(tick_data$Larvae_Count, from = 0, to = max(tick_data$Larvae_Count))#, n = 512)
nymphal_density <- density(tick_data$Nymphs_Count, from = 0, to = max(tick_data$Nymphs_Count))#, n = 512)

# Calculate overlap area
# After obtaining KDEs for both groups, you can analyze how much they overlap. This can be done using various metrics, such as the area under the curves (AUC) or more sophisticated methods that quantify the degree of overlap.
overlap_area <- sum(pmin(larval_density$y, nymphal_density$y)) * (larval_density$x[2] - larval_density$x[1])
overlap_area


# San Francisco Bay Area 0.8881365
# Central Coast 0.3201129
# Los Angeles 0.2953363
```

part b. Jaccard index
```{r}
tick_data <- data_post2010_formatted %>% 
  filter(climate_region == "Los Angeles") %>% 
  filter(month > 2 & month < 7) %>% 
  group_by(climate_region, julian) %>%  
  summarise(total_l = mean(total_l, na.rm = TRUE),
            total_n = mean(total_n, na.rm = TRUE)) %>% 
  dplyr::select(julian, total_l, total_n) %>% 
  rename(Date = julian,
         Larvae_Count = total_l,
         Nymphs_Count = total_n) %>% 
  na.omit()

tick_long <- melt(tick_data, id.vars = "Date", variable.name = "Tick_Type", value.name = "Count")

overlap_count <- sum(pmin(tick_data$Larvae_Count, tick_data$Nymphs_Count))
total_count <- sum(pmax(tick_data$Larvae_Count, tick_data$Nymphs_Count))

# Jaccard index
jaccard_index<- overlap_count / total_count
jaccard_index

# SF 0.4725434
# Central Coast  0.3800453
# Los Angeles 0.223288
```

